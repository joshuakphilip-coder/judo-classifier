<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judo Throw Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1640029074/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-xl p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">ü•ã Judo Throw Classifier</h1>
            <p class="text-gray-600 text-center mb-6">AI-Powered Body Pose Analysis</p>

            <div class="mb-4 p-3 rounded-lg bg-green-50 border border-green-200 text-center">
                <span class="text-green-800 font-medium">‚úÖ Ready: O-Goshi ‚Ä¢ Osoto-Gari ‚Ä¢ Morote-Gari</span>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Video</label>
                <input type="file" id="videoUpload" accept="video/*" 
                       class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-indigo-400 cursor-pointer">
            </div>

            <div id="videoSection" class="hidden mb-6">
                <video id="videoPlayer" class="w-full max-h-96 rounded-lg bg-black mb-3"></video>
                <button id="analyzeBtn" 
                        class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                    üîç Analyze Throw
                </button>
            </div>

            <div id="progress" class="hidden mb-6">
                <div class="bg-gray-200 rounded-full h-3 mb-2">
                    <div id="progressBar" class="bg-indigo-600 h-3 rounded-full transition-all" style="width:0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600 text-center"></p>
            </div>

            <div id="error" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <span class="text-red-800"></span>
            </div>

            <div id="results" class="hidden">
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Results</h3>
                    
                    <div class="bg-white rounded-lg p-6 mb-4 shadow text-center">
                        <p class="text-gray-600 mb-2">Identified Technique:</p>
                        <p id="resultName" class="text-4xl font-bold text-indigo-600 mb-2"></p>
                        <p id="resultDesc" class="text-gray-500 mb-3"></p>
                        <div class="flex items-center justify-center gap-3">
                            <div class="w-64 bg-gray-200 rounded-full h-4">
                                <div id="confidenceBar" class="bg-indigo-600 h-4 rounded-full" style="width:0%"></div>
                            </div>
                            <span id="confidence" class="font-semibold"></span>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-3">All Predictions:</p>
                        <div id="allPredictions"></div>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow">
                        <p class="text-sm font-bold text-gray-800 mb-3">üìö Key Points:</p>
                        <ul id="keyPoints" class="space-y-1 text-sm text-gray-700"></ul>
                    </div>
                </div>
            </div>

            <canvas id="canvas" class="hidden"></canvas>
        </div>
    </div>

<script>
const THROWS = {
    ogoshi: {
        name: "O-Goshi",
        english: "Major Hip Throw",
        category: "Hip Technique",
        points: [
            "Turn back to opponent",
            "Hip deep under opponent's center",
            "Bend forward 45-60 degrees",
            "Arm around waist tightly",
            "Feet parallel and close",
            "Lift while rotating forward"
        ]
    },
    osoto: {
        name: "Osoto-Gari", 
        english: "Major Outer Reap",
        category: "Leg Technique",
        points: [
            "Stay upright facing opponent",
            "Strong collar and sleeve grips",
            "Break balance backward",
            "Sweep leg high behind opponent's leg",
            "Drive chest forward",
            "Follow through backward"
        ]
    },
    morote: {
        name: "Morote-Gari",
        english: "Double Leg Takedown", 
        category: "Hand Technique",
        points: [
            "Drop hips low (level change)",
            "Deep penetration step",
            "Wrap both arms around legs",
            "Head to side of body",
            "Drive forward with legs",
            "Maintain control of both legs"
        ]
    }
};

let pose = null;
let video = null;

function initPose() {
    pose = new Pose({
        locateFile: (file) => "https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/" + file
    });
    
    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
}

function analyzeFrame(landmarks) {
    const scores = {ogoshi: 0, osoto: 0, morote: 0};
    
    const nose = landmarks[0];
    const lShoulder = landmarks[11];
    const rShoulder = landmarks[12];
    const lHip = landmarks[23];
    const rHip = landmarks[24];
    const lKnee = landmarks[25];
    const rKnee = landmarks[26];
    const lAnkle = landmarks[27];
    const rAnkle = landmarks[28];
    
    const hipY = (lHip.y + rHip.y) / 2;
    const shoulderY = (lShoulder.y + rShoulder.y) / 2;
    const noseY = nose.y;
    
    // O-Goshi detection
    if (noseY < shoulderY - 0.05) scores.ogoshi += 3;
    if (Math.abs(lShoulder.x - rShoulder.x) > 0.12) scores.ogoshi += 2;
    if (hipY < 0.55) scores.ogoshi += 2;
    if (Math.abs(lHip.y - rHip.y) > 0.08) scores.ogoshi += 2;
    
    // Osoto detection
    if (noseY > shoulderY + 0.03) scores.osoto += 3;
    if (Math.abs(lShoulder.x - rShoulder.x) < 0.10) scores.osoto += 2;
    const legExtended = Math.abs(lAnkle.y - lKnee.y) > 0.15 || Math.abs(rAnkle.y - rKnee.y) > 0.15;
    if (legExtended) scores.osoto += 3;
    if (shoulderY < 0.35) scores.osoto += 1;
    
    // Morote-Gari detection
    if (hipY > 0.65) scores.morote += 4;
    if (shoulderY > hipY - 0.1) scores.morote += 3;
    const stanceWide = Math.abs(lAnkle.x - rAnkle.x) > 0.25;
    if (stanceWide) scores.morote += 2;
    const kneeLow = Math.min(lKnee.y, rKnee.y) > 0.70;
    if (kneeLow) scores.morote += 2;
    
    return scores;
}

document.getElementById('videoUpload').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    video = document.getElementById('videoPlayer');
    video.src = URL.createObjectURL(file);
    video.load();
    
    document.getElementById('videoSection').classList.remove('hidden');
    document.getElementById('results').classList.add('hidden');
    
    if (!pose) initPose();
};

document.getElementById('analyzeBtn').onclick = async function() {
    const btn = this;
    btn.disabled = true;
    
    document.getElementById('progress').classList.remove('hidden');
    document.getElementById('results').classList.add('hidden');
    updateProgress(0, 'Starting analysis...');
    
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    
    const allScores = {ogoshi: [], osoto: [], morote: []};
    const sampleCount = 10;
    let processed = 0;
    
    try {
        for (let i = 0; i < sampleCount; i++) {
            video.currentTime = (video.duration / sampleCount) * i;
            
            await new Promise(resolve => {
                video.onseeked = resolve;
                setTimeout(resolve, 1000);
            });
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            await new Promise((resolve) => {
                pose.onResults((results) => {
                    if (results.poseLandmarks) {
                        const scores = analyzeFrame(results.poseLandmarks);
                        allScores.ogoshi.push(scores.ogoshi);
                        allScores.osoto.push(scores.osoto);
                        allScores.morote.push(scores.morote);
                    }
                    resolve();
                });
                pose.send({image: canvas});
            });
            
            processed++;
            updateProgress((processed / sampleCount) * 100, 
                `Analyzing frame ${processed}/${sampleCount}...`);
        }
        
        const avg = {
            ogoshi: allScores.ogoshi.reduce((a,b) => a+b, 0) / allScores.ogoshi.length,
            osoto: allScores.osoto.reduce((a,b) => a+b, 0) / allScores.osoto.length,
            morote: allScores.morote.reduce((a,b) => a+b, 0) / allScores.morote.length
        };
        
        const total = avg.ogoshi + avg.osoto + avg.morote;
        const results = [
            {id: 'ogoshi', score: (avg.ogoshi / total) * 100},
            {id: 'osoto', score: (avg.osoto / total) * 100},
            {id: 'morote', score: (avg.morote / total) * 100}
        ].sort((a, b) => b.score - a.score);
        
        showResults(results);
        
    } catch (err) {
        showError('Analysis failed: ' + err.message);
    } finally {
        btn.disabled = false;
        setTimeout(() => {
            document.getElementById('progress').classList.add('hidden');
        }, 1000);
    }
};

function updateProgress(pct, txt) {
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressText').textContent = txt;
}

function showResults(results) {
    const best = results[0];
    const throwData = THROWS[best.id];
    
    document.getElementById('resultName').textContent = throwData.name;
    document.getElementById('resultDesc').textContent = throwData.english + ' ‚Ä¢ ' + throwData.category;
    document.getElementById('confidence').textContent = best.score.toFixed(1) + '%';
    document.getElementById('confidenceBar').style.width = best.score + '%';
    
    let html = '';
    results.forEach(r => {
        const t = THROWS[r.id];
        html += `
            <div class="mb-2">
                <div class="flex justify-between mb-1">
                    <span class="font-medium">${t.name}</span>
                    <span class="text-sm">${r.score.toFixed(1)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-indigo-500 h-2 rounded-full" style="width:${r.score}%"></div>
                </div>
            </div>
        `;
    });
    document.getElementById('allPredictions').innerHTML = html;
    
    let points = '';
    throwData.points.forEach(p => {
        points += `<li>‚úì ${p}</li>`;
    });
    document.getElementById('keyPoints').innerHTML = points;
    
    document.getElementById('results').classList.remove('hidden');
}

function showError(msg) {
    const el = document.getElementById('error');
    el.querySelector('span').textContent = msg;
    el.classList.remove('hidden');
}

console.log('Judo Classifier Ready');
</script>
</body>
</html>
