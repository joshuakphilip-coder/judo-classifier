<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judo Throw Classifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <div class="p-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-xl p-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2 text-center">
                    Judo Throw Classifier
                </h1>
                <p class="text-gray-600 text-center mb-8">
                    Upload reference images, then classify videos
                </p>

                <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Training Mode Password
                            </label>
                            <input
                                type="password"
                                id="adminPassword"
                                placeholder="Enter password"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            />
                            <p class="text-xs text-gray-500 mt-1">Default: admin123</p>
                        </div>
                        <button
                            id="unlockBtn"
                            class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                            Unlock
                        </button>
                    </div>
                </div>

                <div id="trainingSection" class="mb-8 hidden">
                    <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Train the Model</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Throw Name
                            </label>
                            <input
                                type="text"
                                id="throwName"
                                placeholder="e.g., O-Goshi"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            />
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Upload Reference Images
                            </label>
                            <input
                                type="file"
                                id="imageUpload"
                                accept="image/*"
                                multiple
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            />
                            <p class="text-xs text-gray-500 mt-1" id="uploadStatus">
                                Upload 5-20 images per throw type
                            </p>
                        </div>

                        <div id="throwTypesList"></div>

                        <div class="mt-6 pt-4 border-t border-blue-200">
                            <button
                                id="exportBtn"
                                class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 mb-2"
                            >
                                Export Training Data
                            </button>
                            <p class="text-xs text-gray-600 text-center">
                                Save your training to use later
                            </p>
                        </div>
                    </div>
                </div>

                <div id="modelStatus" class="mb-6 p-4 rounded-lg bg-green-50 border border-green-200">
                    <span id="statusText" class="text-green-800">Ready to classify</span>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Upload Video to Classify</h3>
                    <input
                        type="file"
                        id="videoUpload"
                        accept="video/*"
                        class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-lg"
                    />
                </div>

                <div id="videoPreview" class="mb-8 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Video Preview</h3>
                    <video id="videoPlayer" controls class="w-full rounded-lg shadow-md bg-black mb-4"></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    
                    <button
                        id="classifyBtn"
                        class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                    >
                        <span id="classifyBtnText">Classify Throw</span>
                    </button>
                </div>

                <div id="errorMessage" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
                    <span class="text-red-800"></span>
                </div>

                <div id="results" class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-6 hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Results</h3>
                    
                    <div class="bg-white rounded-lg p-6 mb-4 shadow-md text-center">
                        <p class="text-gray-600 mb-2">Identified Throw:</p>
                        <p id="resultThrow" class="text-3xl font-bold text-indigo-600"></p>
                        <p id="resultConfidence" class="text-gray-500 mt-2"></p>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow-md">
                        <p class="text-sm font-medium text-gray-700 mb-3">All Predictions:</p>
                        <div id="allPredictions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
var EMBEDDED_TRAINING_DATA = "";
var ADMIN_PASSWORD = "admin123";
var throwTypes = [];

loadModel();

function loadModel() {
    if (EMBEDDED_TRAINING_DATA && EMBEDDED_TRAINING_DATA !== "") {
        try {
            var data = JSON.parse(EMBEDDED_TRAINING_DATA);
            throwTypes = data.throwTypes || [];
            
            for (var i = 0; i < throwTypes.length; i++) {
                var newImages = [];
                for (var j = 0; j < throwTypes[i].images.length; j++) {
                    var imgData = new ImageData(224, 224);
                    var arr = new Uint8ClampedArray(throwTypes[i].images[j]);
                    imgData.data.set(arr);
                    newImages.push(imgData);
                }
                throwTypes[i].images = newImages;
            }
            
            var total = 0;
            for (var i = 0; i < throwTypes.length; i++) {
                total += throwTypes[i].images.length;
            }
            
            document.getElementById("statusText").textContent = "Model loaded: " + throwTypes.length + " throws, " + total + " images";
        } catch (err) {
            document.getElementById("statusText").textContent = "Error loading: " + err.message;
            document.getElementById("modelStatus").className = "mb-6 p-4 rounded-lg bg-red-50 border border-red-200";
        }
    } else {
        document.getElementById("statusText").textContent = "No training data. Use Training Mode to add throws.";
        document.getElementById("modelStatus").className = "mb-6 p-4 rounded-lg bg-yellow-50 border border-yellow-200";
    }
}

document.getElementById("unlockBtn").onclick = function() {
    if (document.getElementById("adminPassword").value === ADMIN_PASSWORD) {
        document.getElementById("trainingSection").classList.remove("hidden");
        showSuccess("Training mode unlocked!");
    } else {
        showError("Incorrect password");
    }
};

document.getElementById("imageUpload").onchange = function(e) {
    var name = document.getElementById("throwName").value.trim();
    if (!name) {
        showError("Enter throw name first");
        return;
    }
    
    var files = e.target.files;
    if (!files.length) return;
    
    document.getElementById("uploadStatus").textContent = "Processing...";
    this.disabled = true;
    
    var images = [];
    var loaded = 0;
    
    for (var i = 0; i < files.length; i++) {
        var reader = new FileReader();
        reader.onload = (function() {
            return function(event) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement("canvas");
                    canvas.width = 224;
                    canvas.height = 224;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, 224, 224);
                    var data = ctx.getImageData(0, 0, 224, 224);
                    images.push(Array.from(data.data));
                    
                    loaded++;
                    if (loaded === files.length) {
                        var existing = -1;
                        for (var j = 0; j < throwTypes.length; j++) {
                            if (throwTypes[j].name === name) {
                                existing = j;
                                break;
                            }
                        }
                        
                        if (existing >= 0) {
                            throwTypes[existing].images = throwTypes[existing].images.concat(images);
                        } else {
                            throwTypes.push({name: name, images: images});
                        }
                        
                        updateList();
                        document.getElementById("throwName").value = "";
                        document.getElementById("imageUpload").value = "";
                        document.getElementById("imageUpload").disabled = false;
                        document.getElementById("uploadStatus").textContent = loaded + " images added!";
                        setTimeout(function() {
                            document.getElementById("uploadStatus").textContent = "Upload 5-20 images per throw type";
                        }, 2000);
                    }
                };
                img.src = event.target.result;
            };
        })();
        reader.readAsDataURL(files[i]);
    }
};

function updateList() {
    var list = document.getElementById("throwTypesList");
    if (!throwTypes.length) {
        list.innerHTML = "";
        return;
    }
    
    var html = "<div class='mt-4'><h4 class='font-semibold mb-2'>Training Data:</h4>";
    for (var i = 0; i < throwTypes.length; i++) {
        html += "<div class='flex justify-between bg-white p-2 rounded mb-2'>";
        html += "<span>" + throwTypes[i].name + " (" + throwTypes[i].images.length + " images)</span>";
        html += "<button onclick='removeThrow(" + i + ")' class='text-red-600'>Remove</button>";
        html += "</div>";
    }
    html += "</div>";
    list.innerHTML = html;
}

function removeThrow(idx) {
    throwTypes.splice(idx, 1);
    updateList();
}

document.getElementById("exportBtn").onclick = function() {
    if (!throwTypes.length) {
        showError("No data to export");
        return;
    }
    
    var data = JSON.stringify({throwTypes: throwTypes});
    var win = window.open("", "Export", "width=800,height=600");
    win.document.write("<h2>Copy this text:</h2>");
    win.document.write("<p>Paste it into: var EMBEDDED_TRAINING_DATA = \"\";</p>");
    win.document.write("<textarea style='width:100%;height:80%;font-size:10px;'>" + data + "</textarea>");
};

document.getElementById("videoUpload").onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    
    var video = document.getElementById("videoPlayer");
    video.src = URL.createObjectURL(file);
    document.getElementById("videoPreview").classList.remove("hidden");
    document.getElementById("results").classList.add("hidden");
};

document.getElementById("classifyBtn").onclick = function() {
    if (!throwTypes.length) {
        showError("No training data available");
        return;
    }
    
    var btn = this;
    var btnText = document.getElementById("classifyBtnText");
    btn.disabled = true;
    btnText.textContent = "Analyzing...";
    
    var video = document.getElementById("videoPlayer");
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    canvas.width = 224;
    canvas.height = 224;
    
    var frames = [];
    var samples = 10;
    var current = 0;
    
    function capture() {
        if (current >= samples) {
            classify(frames);
            return;
        }
        
        video.currentTime = (video.duration / samples) * current;
        video.onseeked = function() {
            ctx.drawImage(video, 0, 0, 224, 224);
            frames.push(ctx.getImageData(0, 0, 224, 224));
            current++;
            setTimeout(capture, 50);
        };
    }
    
    function classify(frames) {
        var scores = {};
        
        for (var i = 0; i < throwTypes.length; i++) {
            scores[throwTypes[i].name] = [];
        }
        
        for (var i = 0; i < frames.length; i++) {
            for (var j = 0; j < throwTypes.length; j++) {
                var best = 0;
                for (var k = 0; k < throwTypes[j].images.length; k++) {
                    var sim = compare(frames[i], throwTypes[j].images[k]);
                    if (sim > best) best = sim;
                }
                scores[throwTypes[j].name].push(best);
            }
        }
        
        var results = [];
        for (var name in scores) {
            var avg = 0;
            for (var i = 0; i < scores[name].length; i++) {
                avg += scores[name][i];
            }
            avg /= scores[name].length;
            results.push({name: name, score: avg});
        }
        
        results.sort(function(a, b) { return b.score - a.score; });
        
        showResults(results);
        btn.disabled = false;
        btnText.textContent = "Classify Throw";
    }
    
    capture();
};

function compare(img1, img2) {
    var d1 = img1.data;
    var d2 = img2.data;
    var diff = 0;
    
    for (var i = 0; i < d1.length; i += 4) {
        var dr = d1[i] - d2[i];
        var dg = d1[i+1] - d2[i+1];
        var db = d1[i+2] - d2[i+2];
        diff += Math.sqrt(dr*dr + dg*dg + db*db);
    }
    
    var max = Math.sqrt(255*255*3) * (d1.length/4);
    return 1 - (diff/max);
}

function showResults(results) {
    var best = results[0];
    var threshold = 0.5;
    
    document.getElementById("resultThrow").textContent = best.score < threshold ? "Unidentifiable" : best.name;
    document.getElementById("resultThrow").className = "text-3xl font-bold " + (best.score < threshold ? "text-orange-600" : "text-indigo-600");
    document.getElementById("resultConfidence").textContent = "Confidence: " + (best.score * 100).toFixed(1) + "%";
    
    var html = "";
    for (var i = 0; i < results.length; i++) {
        html += "<div class='mb-2'>";
        html += "<div class='flex justify-between mb-1'>";
        html += "<span>" + results[i].name + "</span>";
        html += "<span>" + (results[i].score * 100).toFixed(1) + "%</span>";
        html += "</div>";
        html += "<div class='w-full bg-gray-200 rounded-full h-2'>";
        html += "<div class='bg-indigo-600 h-2 rounded-full' style='width:" + (results[i].score * 100) + "%'></div>";
        html += "</div></div>";
    }
    document.getElementById("allPredictions").innerHTML = html;
    document.getElementById("results").classList.remove("hidden");
}

function showError(msg) {
    document.getElementById("errorMessage").querySelector("span").textContent = msg;
    document.getElementById("errorMessage").classList.remove("hidden");
}

function showSuccess(msg) {
    document.getElementById("statusText").textContent = msg;
    document.getElementById("modelStatus").className = "mb-6 p-4 rounded-lg bg-green-50 border border-green-200";
}
</script>
</body>
</html>
